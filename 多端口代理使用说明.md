# 多端口代理 + 固定证书使用说明

## 功能介绍

新增的 `TestMultiPortWithFixedCert()` 函数演示了以下功能：

### 1. 固定证书功能
- **首次运行**：自动创建证书并保存为 `.p12` 文件
- **后续运行**：自动加载已保存的证书，无需重复生成
- **证书文件**：
  - `sunny_cert.p12` - P12 格式证书文件（包含公钥、私钥和 CA 证书）
  - 证书密码：`sunny2025`（可在代码中修改）

### 2. 多端口代理功能
- 同时启动多个代理端口（默认：8888、8889、8890）
- 所有端口共享同一个证书
- 每个端口独立工作，互不干扰

## 使用方法

### 基本使用

1. **运行程序**：
```bash
python Dome.py
```

2. **配置浏览器/应用代理**：
   - 代理地址：`127.0.0.1`
   - 代理端口：`8888` 或 `8889` 或 `8890`（任选其一）
   - 代理类型：HTTP/HTTPS

3. **停止程序**：
   - 按 `Ctrl+C` 停止所有代理

### 自定义端口

在 `Dome.py` 文件中修改端口列表：

```python
# 修改这一行，添加或删除端口
ports = [8888, 8889, 8890, 9000, 9001]  # 可以添加更多端口
```

### 重新生成证书

如果需要重新生成证书：

1. 删除 P12 证书文件：
```bash
del sunny_cert.p12  # Windows
rm sunny_cert.p12   # Linux/Mac
```

2. 重新运行程序，将自动生成新证书

### 修改证书密码

在代码中修改以下变量：
```python
cert_password = "your_password"  # 改为你想要的密码
```

### 启用进程代理（可选）

如果需要拦截所有进程的网络请求：

1. 以**管理员身份**运行程序
2. 在代码中修改：
```python
enable_driver = True  # 改为 True
```

**注意**：
- 需要管理员权限
- 只能有一个代理实例加载驱动
- 驱动类型可选：
  - `False` = Proxifier 驱动（不支持 UDP）
  - `True` = NFAPI 驱动（Win7 需要 KB3033929 补丁）

## 代码结构

```python
TestMultiPortWithFixedCert()
├── 步骤1: 准备固定证书
│   ├── 检查证书文件是否存在
│   ├── 存在 → 从文件加载
│   └── 不存在 → 创建并保存到文件
│
├── 步骤2: 创建多个代理实例
│   ├── 遍历端口列表
│   ├── 为每个端口创建 SunnyNet 实例
│   ├── 应用固定证书
│   ├── 设置回调函数
│   └── 启动代理服务
│
├── 步骤3: 显示运行状态
│   └── 输出成功启动的端口信息
│
├── 步骤4: 可选 - 启用进程代理
│   └── 需要管理员权限
│
└── 步骤5: 保持程序运行
    └── 等待用户中断（Ctrl+C）
```

## 优势

1. **证书持久化**：避免每次重启都需要重新信任证书
2. **多端口负载**：可以在不同应用中使用不同端口
3. **统一管理**：所有端口使用同一个证书，方便管理
4. **完整示例**：包含详细注释，易于理解和修改

## 常见问题

### Q: 为什么需要多个端口？
A: 
- 不同应用可以使用不同的代理端口
- 便于区分和管理不同来源的流量
- 避免端口冲突

### Q: 证书需要安装到系统吗？
A: 
- 对于 HTTPS 流量，需要安装证书才能正常解密
- 程序会自动安装证书到系统
- 如果证书已安装，不会重复安装

### Q: 如何查看拦截的流量？
A: 
- 在回调函数中可以看到所有请求和响应
- 可以访问脚本管理页面查看和编辑脚本
- 示例中已包含基本的日志输出

## 示例输出

```
============================================================
未检测到证书文件，正在创建新证书...
============================================================
✓ 证书已创建并保存为 P12 格式
  - 文件: sunny_cert.p12
  - 密码: sunny2025

============================================================
正在创建多端口代理实例...
============================================================

>>> 配置端口 8888 的代理...
  ✓ 设置端口: 8888
  ✓ 已应用固定证书
  ✓ 证书已安装到系统
  ✓ 已设置回调函数
  ✓ 端口 8888 代理启动成功
  ✓ 脚本管理页面: http://127.0.0.1:8888/...

[其他端口类似...]

============================================================
多端口代理启动完成！
============================================================
成功启动 3 个代理端口：
  - 0.0.0.0:8888
  - 0.0.0.0:8889
  - 0.0.0.0:8890

使用方法：
  1. 在浏览器或应用中配置 HTTP/HTTPS 代理
  2. 代理地址: 127.0.0.1
  3. 代理端口: 选择上述任意端口（如 8888、8889、8890）
  4. 所有端口使用同一个证书，无需重复配置

程序正在运行中，按 Ctrl+C 停止...
```

## 相关文件

- `Dome.py` - 包含所有示例代码
- `sunny_cert.p12` - P12 格式证书文件（首次运行后生成）
- `SunnyNet/` - SunnyNet 核心库
- `多端口代理使用说明.md` - 本说明文档

## 技术支持

- QQ 交流群：751406884、545120699、170902713、616787804
- 项目网站：https://esunny.vip

